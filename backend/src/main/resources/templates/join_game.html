<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title th:text="'Game' + ${gameId}"></title>

    <link href='http://fonts.googleapis.com/css?family=Montserrat:400,700' rel='stylesheet' type='text/css' />


    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css"
          th:href="@{/webjars/bootstrap/3.3.6/css/bootstrap.min.css}" rel="stylesheet"/>

    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap-theme.min.css"
          th:href="@{/webjars/bootstrap/3.3.6/css/bootstrap-theme.min.css}" rel="stylesheet"/>

    <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css"
          th:href="@{/webjars/font-awesome/4.6.3/css/font-awesome.min.css}" rel="stylesheet"/>

    <link href="../static/css/console.css" th:href="@{/css/arttag.css}" rel="stylesheet"/>
    <link href="../static/css/game_screen.css" th:href="@{/css/game_screen.css}" rel="stylesheet"/>
    <link href="../static/css/loader.css" th:href="@{/css/loader.css}" rel="stylesheet"/>
</head>
<body>
<div class="container-fluid">
    <div class="row">
        <div class="col-md-8 col-lg-8">
            <div class="row" data-bind="if: gameView.table().length > 0 ">
                <div class="game-table col-md-12 col-lg-12">
                    <legend>Table</legend>
                    <div data-bind="template: { name: 'card-thumbnail', foreach: gameView.table }"></div>
                </div>
            </div>

            <div class="row" data-bind="if: hand().length > 0 &amp;&amp; !(gameView.table().length > 0)">
                <div class="hand col-md-12 col-lg-12">
                    <legend>Hand</legend>
                    <div data-bind="template: { name: 'card-thumbnail', foreach: hand }"></div>
                </div>
            </div>
        </div>

        <div class="col-md-4 col-lg-4">
            <div class="row">
                <div class="panel panel-default">
                    <div class="panel-heading">
                        <h3 class="panel-title">Game</h3>
                    </div>
                    <div class="panel-body">
                        Id: <b data-bind="text: gameView.id"/><br/>
                        Name: <b data-bind="text: gameView.name"/><br/>
                        Round Remaining Time: <b data-bind="text: gameView.remainingTime"/><br/>
                        Status: <b data-bind="text: gameView.status"/><br/>
                        Tags: <b data-bind="text: gameView.tags"/><br/>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="players panel panel-default">
                    <div class="panel-heading">
                        <h3 class="panel-title">Players</h3>
                    </div>
                    <div class="panel-body">
                        <ul data-bind="foreach: gameView.players">
                            <li data-bind="template: { name: 'player-line'}"></li>
                        </ul>
                        <div data-bind="if: gameView.status() === 'ROUND_FINISHED'">
                            <button class="btn btn-default" data-bind="click: sendPlayerReady">Ready for next round</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="chat panel panel-default">
                    <div class="panel-heading">
                        <h3 class="panel-title">Chat</h3>
                    </div>
                    <div class="panel-body">
                        <ul data-bind="foreach: chatHistory">
                            <li data-bind="if: message">
                                <p class="chat-body" data-bind="template: { name: 'chat-line'}, autoScroll: true"></p>
                            </li>
                        </ul>
                    </div>
                    <div class="panel-footer">
                        <div class="input-group">
                            <input type="text" class="form-control input-sm"
                                   data-bind="textInput : chatInput, event: {keypress: enterChatMessage}"
                                   placeholder="Type your message here..."/>
                        <span class="input-group-btn">
                            <button class="btn btn-warning btn-sm" data-bind="click: sendChatMessage">
                                Send</button>
                        </span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal window with image preview, and user inputs -->
    <div id="imageModal" class="modal fade" tabindex="-1" role="dialog">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-12">
                            <img class="img-responsive"/>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-12">
                            <div class="form-horizontal">
                                <input type="hidden" class="modal-id"/>
                                <div class="form-group">
                                    <label class="col-sm-2 control-label">Url</label>
                                    <div class="col-sm-10">
                                        <p class="form-control-static" id="modal-id"></p>
                                    </div>
                                </div>
                                <!-- TAG INPUT -->
                                <div class="form-group" data-bind="if: dealer() &amp;&amp; gameView.status() === 'ROUND_STARTED'">
                                    <label class="col-sm-2 control-label">Topic</label>
                                    <div class="col-sm-10">
                                        <div class="input-group">
                                            <input type="text" class="form-control input-sm"
                                                   data-bind="textInput: tagsInput, event: {keypress: enterTag}" placeholder="Write round topic here..."/>
                                            <span class="input-group-btn">
                                                <button class="btn btn-warning btn-sm" data-bind="click: sendTag">Send</button>
                                            </span>
                                        </div>
                                    </div>
                                </div>
                                <!-- HAND CARD SELECTION -->
                                <div class="form-group" data-bind="if: !dealer() &amp;&amp; gameView.status() === 'ROUND_TOPIC_SELECTED'">
                                    <label class="col-sm-2 control-label"></label>
                                    <div class="col-sm-10">
                                        <button class="btn btn-success btn-block" data-bind="click: selectHandCard">Select this card</button>
                                    </div>
                                </div>

                                <!-- TABLE CARD SELECTION -->
                                <div class="form-group" data-bind="if: gameView.status() === 'ROUND_OWN_CARDS_SELECTED'">
                                    <label class="col-sm-2 control-label"></label>
                                    <div class="col-sm-10">
                                        <button class="btn btn-success btn-block" data-bind="click: selectTableCard">Select this card</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="https://code.jquery.com/jquery-2.2.4.min.js" th:src="@{/webjars/jquery/2.2.4/jquery.min.js}"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"
        th:src="@{/webjars/bootstrap/3.3.6/js/bootstrap.min.js}"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/knockout/3.4.0/knockout-min.js"
        th:src="@{/webjars/knockout/3.4.0/knockout.js}"></script>
<script src="../static/js/knockout.mapping.js" th:src="@{/js/knockout.mapping.js}"></script>
<script src="../static/js/md5.js" th:src="@{/js/md5.js}"></script>
<script src="../static/js/hashcode.js" th:src="@{/js/hashcode.js}"></script>
<script src="../static/js/arttag.js" th:src="@{/js/arttag.js}"></script>
<script src="../static/js/loader.js" th:src="@{/js/loader.js}"></script>

<script type="text/html" id="chat-line">
    <span data-bind="text: time"></span>
    <strong data-bind="text: player"></strong>:
    <span data-bind="text: message"></span>
</script>

<script type="text/html" id="player-line">
    <em data-bind="text: name"></em>
    <strong data-bind="text: dealer() ? '(D)' : ''"></strong>
    <strong data-bind="text: readyForNextRound() ? '(y)' : ''"></strong>
    <strong data-bind="text: inactive() ? '(i)' : ''"></strong>
</script>

<script type="text/html" id="card-thumbnail">
    <div class="col-lg-3 col-md-4 col-xs-6 thumb">
        <a class="thumbnail" href="#">
            <img class="img-responsive"
                 data-toggle="modal"
                 data-target="#imageModal"
                 data-bind="attr: {'src': source,'data-id': token}"/>
        </a>
    </div>
</script>

<script type="text/javascript" th:inline="javascript">
    /* <![CDATA[ */
    var hostname = /*[[${@environment.getProperty('application.hostname')}]]*/;
    var contextPath = /*[[@{/}]]*/;
    var gameId = /*[[${gameId}]]*/;
    var webSocket = new WebSocket(`ws://${hostname}${contextPath}ws/game?gameId=${gameId}`);
    var alreadyConnected = false;

    // show loader on start
    $('body').loader();
    $.loader.open();

    // handles scrolling of chat messages always to bottom
    ko.bindingHandlers.autoScroll = {
        update: function (element, valueAccessor, allBindings, viewModel, bindingContext) {
            $(element).parents('.panel-body').scrollTop($(element).parents('.panel-body')[0].scrollHeight);
        }
    };

    /*
     Specifies keys to use for comparing change of objects by knockout-mapping plugin.
     With this, only when change in key is detected, mapping will refresh the element in DOM.
     */
    var mapping = {
        'hand': {
            key: function (data) {
                return ko.utils.unwrapObservable(data.token);
            }
        },
        'table': {
            key: function (data) {
                return ko.utils.unwrapObservable(data.token);
            }
        },
        'players': {
            key: function (data) {
                return ko.utils.unwrapObservable(HashCode.value(data));
            }
        }
    };

    // knockoutJS viewModel for this page
    function ViewModel(data) {
        data = data || {};
        var self = this;
        self = ko.mapping.fromJS(data, mapping);

        self.enterChatMessage = function (d, e) {
            e.keyCode === 13 && self.sendChatMessage();
            return true;
        };

        self.enterTag = function (d, e) {
            e.keyCode === 13 && self.sendTag();
            return true;
        };

        self.sendChatMessage = function () {
            if (self.chatInput()) {
                var message = {
                    value: ko.utils.unwrapObservable(self.chatInput()),
                    type: 'CHAT_MESSAGE',
                    gameId: ko.utils.unwrapObservable(self.gameView.id())
                };
                webSocket.send(JSON.stringify(message));
                var date = new Date();
                self.chatHistory.push({player: "me", message: self.chatInput(), time: date.toLocaleTimeString()});
                self.chatInput('');
            }
        };

        self.sendTag = function () {
            if (self.tagsInput()) {
                var selectedCard = $(".modal-body .modal-id").val();
                var message = {
                    value: ko.utils.unwrapObservable(self.tagsInput()) + ";" + selectedCard,
                    type: 'TOPIC_SELECTED',
                    gameId: ko.utils.unwrapObservable(self.gameView.id())
                };
                webSocket.send(JSON.stringify(message));
                self.tagsInput("");
                $('#imageModal').modal('hide');
            }
        };

        self.sendPlayerReady = function () {
            var message = {
                value: 'OK',
                type: 'PLAYER_READY_FOR_NEXT_ROUND',
                gameId: ko.utils.unwrapObservable(self.gameView.id())
            };
            webSocket.send(JSON.stringify(message));
        };

        self.selectHandCard = function () {
            var selectedCard = $(".modal-body .modal-id").val();
            var message = {
                value: selectedCard,
                type: 'OWN_CARD_SELECTED',
                gameId: ko.utils.unwrapObservable(self.gameView.id())
            };
            webSocket.send(JSON.stringify(message));
            $('#imageModal').modal('hide');
        };

        self.selectTableCard = function () {
            var selectedCard = $(".modal-body .modal-id").val();
            var message = {
                value: selectedCard,
                type: 'TABLE_CARD_SELECTED',
                gameId: ko.utils.unwrapObservable(self.gameView.id())
            };
            webSocket.send(JSON.stringify(message));
            $('#imageModal').modal('hide');
        };


        return self;
    }

    // viewModel prototype
    var viewModel = new ViewModel({
        "userToken": "",
        "dealer": false,
        "hand": [{
            "token": "",
            "source": ""
        }],
        "gameView": {
            "id": "",
            "name": "",
            "status": "",
            "tags": "",
            "remainingTime": 0,
            "players": [{
                "token": "",
                "name": "admin",
                "readyForNextRound": false,
                "dealer": false,
                "inactive": false
            }],
            "table": [{
                "token": "",
                "source": ""
            }]
        },
        "chatHistory": [{
            "player": "",
            "message": "",
            "time": ""
        }],
        "chatInput": "",
        "tagsInput": ""
    });
    ko.applyBindings(viewModel);

    // websocket on error handler
    webSocket.onerror = function (event) {
        alert(event.data);
    };

    // websocket on message handler
    webSocket.onmessage = function (event) {
        var data = JSON.parse(event.data);
        // chat message
        if (typeof data.type !== 'undefined') {
            var date = new Date();
            viewModel.chatHistory.push({
                player: data.playerName,
                message: data.value,
                time: date.toLocaleTimeString()
            });
        } else { // model message
            ko.mapping.fromJS(data, mapping, viewModel);
            // close loader on first data arrival from server
            if (!alreadyConnected) {
                $.loader.close();
            }
            alreadyConnected = true;
        }
    };

    $(document).on("click", ".thumbnail .img-responsive", function () {
        var id = $(this).attr('data-id');
        var src = $(this).attr('src');
        $(".modal-body .modal-id").val(id);
        $(".modal-body #modal-id").text(id); // TODO: remove this
        $(".modal-body .img-responsive").attr('src', src);
    });
    /* ]]> */
</script>
</body>
</html>
